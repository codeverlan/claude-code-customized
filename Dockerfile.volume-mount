# Claude Code Customizations - Volume Mount Approach
# Runs Claude Code with customizations, binary mounted from host

FROM ubuntu:22.04

# Set non-interactive frontend for apt
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    nodejs \
    npm \
    bash \
    ca-certificates \
    unzip \
    tar \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create user with configurable settings
# These will be overridden by environment variables at runtime
ENV CONTAINER_USER=${CONTAINER_USER:-claude}
ENV CONTAINER_GROUP=${CONTAINER_GROUP:-claude}
ENV CONTAINER_UID=${CONTAINER_UID:-1000}
ENV CONTAINER_GID=${CONTAINER_GID:-1000}
ENV CONTAINER_HOME_DIR=${CONTAINER_HOME_DIR:-/home/claude}

# Create user and group with specified IDs
RUN groupadd -g ${CONTAINER_GID} ${CONTAINER_GROUP} && \
    useradd -m -s /bin/bash -u ${CONTAINER_UID} -g ${CONTAINER_GID} ${CONTAINER_USER} && \
    echo "${CONTAINER_USER} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Set user and home directory variables
ENV USER=${CONTAINER_USER}
ENV HOME=${CONTAINER_HOME_DIR}
ENV CLAUDE_USER=${CONTAINER_USER}

# Set working directory
WORKDIR $HOME

# Set environment variables for Claude Code with defaults
ENV CLAUDE_CODE_SESSION=${CLAUDE_CODE_SESSION:-1}
ENV CLAUDE_CODE_ENTRYPOINT=${CLAUDE_CODE_ENTRYPOINT:-cli}
ENV CLAUDECODE=${CLAUDECODE:-1}
ENV CLAUDE_AUTO_COMPACT_BUFFER_RATIO=${CLAUDE_AUTO_COMPACT_BUFFER_RATIO:-0.05}
ENV CLAUDE_CONTEXT_AUTOCOMPACT_TARGET=${CLAUDE_CONTEXT_AUTOCOMPACT_TARGET:-5%}
ENV CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=${CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC:-1}

# Configurable directories
ENV PROJECTS_DIR=${PROJECTS_DIR:-$HOME/projects}
ENV CLAUDE_CONFIG_DIR=${CLAUDE_CONFIG_DIR:-$HOME/.claude}
ENV LOCAL_BIN_DIR=${LOCAL_BIN_DIR:-$HOME/.local/bin}
ENV SYSTEM_PROMPT_DIR=${SYSTEM_PROMPT_DIR:-$PROJECTS_DIR/claude-system-prompts}

# System prompt configuration
ENV CLAUDE_SYSTEM_PROMPT_DIR=${SYSTEM_PROMPT_DIR}
ENV CLAUDE_DEFAULT_BASE_PROMPT=${CLAUDE_DEFAULT_BASE_PROMPT:-base/core-enhancement.md}

# Permission escalation
ENV CLAUDE_SUDO_ESCALATION_ENABLED=${CLAUDE_SUDO_ESCALATION_ENABLED:-1}
ENV CLAUDE_AUTO_ESCALATE_ON_PERMISSION_ERROR=${CLAUDE_AUTO_ESCALATE_ON_PERMISSION_ERROR:-1}

# Configure PATH with custom directories
ENV PATH="$PATH:${LOCAL_BIN_DIR}:${SYSTEM_PROMPT_DIR}/scripts"

# Create directory structure using environment variables
RUN mkdir -p ${CLAUDE_CONFIG_DIR}/{commands,skills,hooks,agents,projects,session-env,system-prompts/{base,append,context,domains,core,scripts},todos} && \
    mkdir -p ${LOCAL_BIN_DIR} && \
    mkdir -p ${PROJECTS_DIR} && \
    mkdir -p ${HOME}/.config/mcp

# Copy optimized settings
COPY settings.json.template ${CLAUDE_CONFIG_DIR}/settings.json

# Copy system prompt management scripts
COPY claude-system-prompts/ ${SYSTEM_PROMPT_DIR}/
RUN chmod +x ${SYSTEM_PROMPT_DIR}/scripts/*.sh

# Copy slash commands
COPY claude-commands/ ${CLAUDE_CONFIG_DIR}/commands/

# Copy setup script
COPY setup-claude-customizations.sh /usr/local/bin/setup-claude-customizations.sh
RUN chmod +x /usr/local/bin/setup-claude-customizations.sh

# Copy README for projects directory
COPY README-projects.md ${PROJECTS_DIR}/README.md

# Create symlinks using configurable directories
RUN ln -sf ${CLAUDE_CONFIG_DIR}/commands ${PROJECTS_DIR}/claude-commands && \
    ln -sf ${CLAUDE_CONFIG_DIR}/skills ${PROJECTS_DIR}/claude-skills && \
    ln -sf ${CLAUDE_CONFIG_DIR}/hooks ${PROJECTS_DIR}/claude-hooks && \
    ln -sf ${CLAUDE_CONFIG_DIR}/agents ${PROJECTS_DIR}/claude-agents && \
    ln -sf ${CLAUDE_CONFIG_DIR}/todos ${PROJECTS_DIR}/claude-todos && \
    ln -sf ${CLAUDE_CONFIG_DIR}/projects ${PROJECTS_DIR}/claude-projects && \
    ln -sf ${CLAUDE_CONFIG_DIR}/session-env ${PROJECTS_DIR}/claude-sessions && \
    ln -sf ${CLAUDE_CONFIG_DIR}/system-prompts ${PROJECTS_DIR}/claude-system-prompts && \
    ln -sf ${HOME}/.config/mcp ${PROJECTS_DIR}/mcp-config

# Create a startup script that uses environment variables
RUN cat > /usr/local/bin/start-claude.sh << 'EOF'
#!/bin/bash

# Get environment variables with defaults
CLAUDE_BINARY_MOUNT_POINT="${CLAUDE_BINARY_MOUNT_POINT:-/claude-binaries}"
LOCAL_BIN_DIR="${LOCAL_BIN_DIR:-$HOME/.local/bin}"
PROJECTS_DIR="${PROJECTS_DIR:-$HOME/projects}"
SYSTEM_PROMPT_DIR="${SYSTEM_PROMPT_DIR:-$PROJECTS_DIR/claude-system-prompts}"

echo "=== Claude Code Startup Configuration ==="
echo "User: $USER"
echo "Home: $HOME"
echo "Projects Dir: $PROJECTS_DIR"
echo "System Prompts: $SYSTEM_PROMPT_DIR"
echo "Local Bin: $LOCAL_BIN_DIR"
echo "Binary Mount: $CLAUDE_BINARY_MOUNT_POINT"
echo

# Check if Claude binary is available
if [ -f "${CLAUDE_BINARY_MOUNT_POINT}/claude" ]; then
    cp "${CLAUDE_BINARY_MOUNT_POINT}/claude" "${LOCAL_BIN_DIR}/claude"
    chmod +x "${LOCAL_BIN_DIR}/claude"
    echo "✅ Claude Code binary mounted successfully"
else
    echo "⚠️  Claude Code binary not found at ${CLAUDE_BINARY_MOUNT_POINT}"
    echo "   Please mount your Claude binary to ${CLAUDE_BINARY_MOUNT_POINT}"
fi

# Test passwordless sudo
echo "Testing passwordless sudo configuration..."
if sudo -n true 2>/dev/null; then
    echo "✅ Passwordless sudo is properly configured"
else
    echo "❌ Passwordless sudo configuration failed"
    exit 1
fi

# Run setup
/usr/local/bin/setup-claude-customizations.sh

# Test sudo escalation scripts
echo "Testing sudo escalation functionality..."
if command -v task-with-sudo.sh >/dev/null 2>&1; then
    echo "✅ Sudo escalation scripts available"
else
    echo "❌ Sudo escalation scripts not found in PATH"
fi

echo
echo "=== Claude Code Environment Ready! ==="
echo "Binary location: ${LOCAL_BIN_DIR}/claude"
echo "Customizations: ${PROJECTS_DIR}"
echo "System prompts: ${SYSTEM_PROMPT_DIR}"
echo "Sudo escalation: ENABLED"
echo "Default base prompt: ${CLAUDE_DEFAULT_BASE_PROMPT:-base/core-enhancement.md}"
echo
EOF
RUN chmod +x /usr/local/bin/start-claude.sh

# Set proper ownership using environment variables
RUN chown -R ${USER}:${USER} ${HOME}

# Switch to user
USER ${USER}

# Expose volumes using environment variables
VOLUME ${PROJECTS_DIR}
VOLUME ${CLAUDE_BINARY_MOUNT_POINT}

# Set working directory for runtime
WORKDIR ${CONTAINER_WORK_DIR:-/workspace}

# Run startup script and then bash
CMD ["/bin/bash", "-c", "/usr/local/bin/start-claude.sh && /bin/bash"]